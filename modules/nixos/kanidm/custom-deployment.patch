From 7d106de1133a75acdaf0fd49ed2f651803e4143c Mon Sep 17 00:00:00 2001
From: Yifei Sun <ysun@hey.com>
Date: Tue, 12 Aug 2025 19:08:20 +0200
Subject: [PATCH] stepbrobd: custom deployment patch

---
 server/core/src/https/middleware/caching.rs |  2 +-
 server/core/src/https/mod.rs                | 19 ++++++++++++-------
 server/core/templates/base.html             |  1 +
 server/core/templates/base_htmx.html        |  1 +
 4 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/server/core/src/https/middleware/caching.rs b/server/core/src/https/middleware/caching.rs
index c1718704..bd2e46ef 100644
--- a/server/core/src/https/middleware/caching.rs
+++ b/server/core/src/https/middleware/caching.rs
@@ -10,7 +10,7 @@ pub async fn dont_cache_me(request: Request<Body>, next: Next) -> Response {
     let mut response = next.run(request).await;
     response.headers_mut().insert(
         header::CACHE_CONTROL,
-        HeaderValue::from_static("no-store, no-cache, max-age=0"),
+        HeaderValue::from_static("private, no-store, no-cache, max-age=0"),
     );
     response
         .headers_mut()
diff --git a/server/core/src/https/mod.rs b/server/core/src/https/mod.rs
index 17672818..101be6a3 100644
--- a/server/core/src/https/mod.rs
+++ b/server/core/src/https/mod.rs
@@ -200,13 +200,18 @@ pub async fn create_https_server(
 
     let csp_header = format!(
         concat!(
-            "default-src 'self'; ",
-            "base-uri 'self' https:; ",
-            "form-action 'self' https:;",
-            "frame-ancestors 'none'; ",
-            "img-src 'self' data:; ",
-            "worker-src 'none'; ",
-            "script-src 'self' 'unsafe-eval'{};",
+            "default-src 'self' https://ysun.co https://*.ysun.co; ",
+            "base-uri 'self' https://ysun.co https://*.ysun.co https:; ",
+            "form-action 'self' https://ysun.co https://*.ysun.co https:; ",
+            "frame-ancestors 'self' https://ysun.co https://*.ysun.co; ",
+            "img-src 'self' https://ysun.co https://*.ysun.co data:; ",
+            "worker-src 'self' https://ysun.co https://*.ysun.co; ",
+            "font-src 'self' https://ysun.co https://*.ysun.co data:; ",
+            "script-src 'self' 'unsafe-inline' 'unsafe-eval'{} https://ysun.co https://*.ysun.co https://static.cloudflareinsights.com; ",
+            "connect-src 'self' https://ysun.co https://*.ysun.co https://cloudflareinsights.com; ",
+            "style-src 'self' 'unsafe-inline' https://ysun.co https://*.ysun.co; ",
+            "frame-src 'self' https://ysun.co https://*.ysun.co; ",
+            "media-src 'self' https://ysun.co https://*.ysun.co;"
         ),
         js_checksums
     );
diff --git a/server/core/templates/base.html b/server/core/templates/base.html
index 4455c680..df9ec3d8 100644
--- a/server/core/templates/base.html
+++ b/server/core/templates/base.html
@@ -22,6 +22,7 @@
 			href="/pkg/style.css?v=((crate::https::cache_buster::get_cache_buster_key()))" />
 
 		(% block head %)(% endblock %)
+        <script defer data-domain="sso.ysun.co" src="https://stats.ysun.co/js/script.file-downloads.hash.outbound-links.js"></script>
 	</head>
 	<body class="flex-column d-flex h-100">
 		(% block body %)(% endblock %)
diff --git a/server/core/templates/base_htmx.html b/server/core/templates/base_htmx.html
index a749fcf7..273100da 100644
--- a/server/core/templates/base_htmx.html
+++ b/server/core/templates/base_htmx.html
@@ -26,6 +26,7 @@
 			href="/pkg/style.css?v=((crate::https::cache_buster::get_cache_buster_key()))" />
 
 		(% block head %)(% endblock %)
+        <script defer data-domain="sso.ysun.co" src="https://stats.ysun.co/js/script.file-downloads.hash.outbound-links.js"></script>
 	</head>
 	<body hx-boost="true" class="flex-column d-flex h-100">
 		(% block nav %)(% endblock %)
-- 
2.50.1

